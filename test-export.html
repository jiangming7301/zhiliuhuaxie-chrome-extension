<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>导出功能测试</title>
  <style>
    body {
      width: 350px;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 10px;
    }
    .btn-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    .btn-info:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">导出功能测试</div>
  </div>
  
  <button id="exportBtn" class="btn btn-info">导出文档</button>
  
  <script>
    // 模拟Chrome扩展环境
    window.chrome = {
      storage: {
        local: {
          get: function(keys) {
            return Promise.resolve({
              operations: [
                {
                  type: 'click',
                  text: '登录按钮',
                  url: 'https://example.com/login',
                  timestamp: Date.now(),
                  screenshot: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                },
                {
                  type: 'click',
                  text: '提交表单',
                  url: 'https://example.com/form',
                  timestamp: Date.now() + 1000,
                  screenshot: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }
              ]
            });
          }
        }
      },
      runtime: {
        sendMessage: function(message) {
          return Promise.resolve({ success: true });
        }
      }
    };

    // 简化的导出功能类
    class TestExportManager {
      constructor() {
        this.usageInfo = { isPremium: true };
        this.bindEvents();
      }

      bindEvents() {
        document.getElementById('exportBtn').addEventListener('click', () => this.exportDocument());
      }

      async exportDocument() {
        try {
          const result = await chrome.storage.local.get(['operations']);
          const operations = result.operations || [];
          
          if (operations.length === 0) {
            alert('没有可导出的记录');
            return;
          }
          
          // 显示导出选项（专业版）
          const exportOperations = operations.filter(op => op.type === 'click' && op.screenshot);
          this.showExportOptions(exportOperations);
          
        } catch (error) {
          console.error('导出文档失败:', error);
          alert('导出文档失败: ' + error.message);
        }
      }
      
      showExportOptions(operations) {
        // 创建导出选项对话框
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background-color: white;
          border-radius: 8px;
          padding: 20px;
          width: 300px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        `;
        
        dialog.innerHTML = `
          <h3 style="margin-top: 0; color: #333; font-size: 18px;">选择导出格式</h3>
          <p style="color: #666; font-size: 14px;">共 ${operations.length} 个操作步骤</p>
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <button id="exportPDF" style="padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">📄 PDF格式</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">通过打印对话框保存，仅包含截图</span>
            </button>
            <button id="exportWord" style="padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">📝 Word格式</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">直接下载DOCX文件，仅包含截图</span>
            </button>
            <button id="exportMarkdown" style="padding: 10px; background-color: #607D8B; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">📋 Markdown格式</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">直接下载MD文件，仅包含截图</span>
            </button>
            <button id="cancelExport" style="padding: 8px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px;">
              取消
            </button>
          </div>
        `;
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // 绑定事件
        document.getElementById('exportPDF').addEventListener('click', () => {
          modal.remove();
          alert('PDF导出功能已触发！在实际扩展中会打开打印对话框。');
        });
        
        document.getElementById('exportWord').addEventListener('click', () => {
          modal.remove();
          this.exportToWord(operations);
        });
        
        document.getElementById('exportMarkdown').addEventListener('click', () => {
          modal.remove();
          alert('Markdown导出功能已触发！在实际扩展中会下载.md文件。');
        });
        
        document.getElementById('cancelExport').addEventListener('click', () => {
          modal.remove();
        });
      }
      
      async exportToWord(operations) {
        try {
          const htmlDoc = this.generateWordHTMLDocument(operations);
          const blob = new Blob([htmlDoc], { type: 'application/msword' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `操作流程文档_${new Date().toISOString().slice(0, 10)}.doc`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('Word文档已生成并下载！图片尺寸已优化为20cm宽度，适配A4横向页面布局。');
        } catch (error) {
          console.error('导出Word文档失败:', error);
          alert('导出Word文档失败: ' + error.message);
        }
      }
      
      generateWordHTMLDocument(operations) {
        const html = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>操作流程文档</title>
            <style>
              body {
                font-family: 'Microsoft YaHei', SimHei, Arial, sans-serif;
                line-height: 1.6;
                color: #333;
                margin: 0;
                padding: 20px;
                max-width: 25cm;
                margin: 0 auto;
              }
              h1 {
                font-size: 24px;
                color: #333;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #4CAF50;
                padding-bottom: 10px;
              }
              h2 {
                font-size: 18px;
                color: #333;
                margin-top: 20px;
                margin-bottom: 10px;
              }
              .step { margin-bottom: 20px; page-break-inside: avoid; }
              .step-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; }
              .step-info { color: #666; font-size: 14px; margin-bottom: 10px; }
              .screenshot {
                max-width: 100%;
                width: 20cm;
                height: auto;
                display: block;
                margin: 0 auto;
                border: 1px solid #ddd;
              }
              a {
                transition: all 0.3s ease;
              }
              a:hover {
                background: #5a4fcf !important;
                transform: scale(1.05);
              }
              @page {
                size: A4 landscape;
                margin: 2cm;
              }
              @media print {
                body {
                  max-width: 25cm;
                  margin: 0 auto;
                }
                .screenshot {
                  max-width: 100% !important;
                  width: 20cm !important;
                  height: auto !important;
                  page-break-inside: avoid;
                }
              }
            </style>
          </head>
          <body>
            <h1>操作流程文档</h1>
            <p>生成时间: ${new Date().toLocaleString()}</p>
            ${operations.map((op, index) => `
              <div class="step">
                <div class="step-title">步骤 ${index + 1}: ${op.text || '未知操作'}</div>
                <div class="step-info">URL: ${op.url || '未知'}</div>
                <div class="step-info">时间: ${new Date(op.timestamp).toLocaleString()}</div>
                ${op.screenshot ? `<img src="${op.screenshot}" alt="操作截图" class="screenshot">` : ''}
              </div>
            `).join('')}
          </body>
          </html>
        `;
        return html;
      }
    }

    // 初始化测试管理器
    document.addEventListener('DOMContentLoaded', () => {
      new TestExportManager();
    });
  </script>
</body>
</html>