<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      width: 350px;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      margin-bottom: 10px;
    }
    .btn-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    .btn-info:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</div>
  </div>
  
  <button id="exportBtn" class="btn btn-info">å¯¼å‡ºæ–‡æ¡£</button>
  
  <script>
    // æ¨¡æ‹ŸChromeæ‰©å±•ç¯å¢ƒ
    window.chrome = {
      storage: {
        local: {
          get: function(keys) {
            return Promise.resolve({
              operations: [
                {
                  type: 'click',
                  text: 'ç™»å½•æŒ‰é’®',
                  url: 'https://example.com/login',
                  timestamp: Date.now(),
                  screenshot: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                },
                {
                  type: 'click',
                  text: 'æäº¤è¡¨å•',
                  url: 'https://example.com/form',
                  timestamp: Date.now() + 1000,
                  screenshot: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }
              ]
            });
          }
        }
      },
      runtime: {
        sendMessage: function(message) {
          return Promise.resolve({ success: true });
        }
      }
    };

    // ç®€åŒ–çš„å¯¼å‡ºåŠŸèƒ½ç±»
    class TestExportManager {
      constructor() {
        this.usageInfo = { isPremium: true };
        this.bindEvents();
      }

      bindEvents() {
        document.getElementById('exportBtn').addEventListener('click', () => this.exportDocument());
      }

      async exportDocument() {
        try {
          const result = await chrome.storage.local.get(['operations']);
          const operations = result.operations || [];
          
          if (operations.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•');
            return;
          }
          
          // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹ï¼ˆä¸“ä¸šç‰ˆï¼‰
          const exportOperations = operations.filter(op => op.type === 'click' && op.screenshot);
          this.showExportOptions(exportOperations);
          
        } catch (error) {
          console.error('å¯¼å‡ºæ–‡æ¡£å¤±è´¥:', error);
          alert('å¯¼å‡ºæ–‡æ¡£å¤±è´¥: ' + error.message);
        }
      }
      
      showExportOptions(operations) {
        // åˆ›å»ºå¯¼å‡ºé€‰é¡¹å¯¹è¯æ¡†
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background-color: white;
          border-radius: 8px;
          padding: 20px;
          width: 300px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        `;
        
        dialog.innerHTML = `
          <h3 style="margin-top: 0; color: #333; font-size: 18px;">é€‰æ‹©å¯¼å‡ºæ ¼å¼</h3>
          <p style="color: #666; font-size: 14px;">å…± ${operations.length} ä¸ªæ“ä½œæ­¥éª¤</p>
          <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
            <button id="exportPDF" style="padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">ğŸ“„ PDFæ ¼å¼</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">é€šè¿‡æ‰“å°å¯¹è¯æ¡†ä¿å­˜ï¼Œä»…åŒ…å«æˆªå›¾</span>
            </button>
            <button id="exportWord" style="padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">ğŸ“ Wordæ ¼å¼</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">ç›´æ¥ä¸‹è½½DOCXæ–‡ä»¶ï¼Œä»…åŒ…å«æˆªå›¾</span>
            </button>
            <button id="exportMarkdown" style="padding: 10px; background-color: #607D8B; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
              <span style="font-size: 16px;">ğŸ“‹ Markdownæ ¼å¼</span>
              <span style="display: block; font-size: 12px; font-weight: normal; margin-top: 3px;">ç›´æ¥ä¸‹è½½MDæ–‡ä»¶ï¼Œä»…åŒ…å«æˆªå›¾</span>
            </button>
            <button id="cancelExport" style="padding: 8px; background-color: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; margin-top: 5px;">
              å–æ¶ˆ
            </button>
          </div>
        `;
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('exportPDF').addEventListener('click', () => {
          modal.remove();
          alert('PDFå¯¼å‡ºåŠŸèƒ½å·²è§¦å‘ï¼åœ¨å®é™…æ‰©å±•ä¸­ä¼šæ‰“å¼€æ‰“å°å¯¹è¯æ¡†ã€‚');
        });
        
        document.getElementById('exportWord').addEventListener('click', () => {
          modal.remove();
          this.exportToWord(operations);
        });
        
        document.getElementById('exportMarkdown').addEventListener('click', () => {
          modal.remove();
          alert('Markdownå¯¼å‡ºåŠŸèƒ½å·²è§¦å‘ï¼åœ¨å®é™…æ‰©å±•ä¸­ä¼šä¸‹è½½.mdæ–‡ä»¶ã€‚');
        });
        
        document.getElementById('cancelExport').addEventListener('click', () => {
          modal.remove();
        });
      }
      
      async exportToWord(operations) {
        try {
          const htmlDoc = this.generateWordHTMLDocument(operations);
          const blob = new Blob([htmlDoc], { type: 'application/msword' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `æ“ä½œæµç¨‹æ–‡æ¡£_${new Date().toISOString().slice(0, 10)}.doc`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('Wordæ–‡æ¡£å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼å›¾ç‰‡å°ºå¯¸å·²ä¼˜åŒ–ä¸º20cmå®½åº¦ï¼Œé€‚é…A4æ¨ªå‘é¡µé¢å¸ƒå±€ã€‚');
        } catch (error) {
          console.error('å¯¼å‡ºWordæ–‡æ¡£å¤±è´¥:', error);
          alert('å¯¼å‡ºWordæ–‡æ¡£å¤±è´¥: ' + error.message);
        }
      }
      
      generateWordHTMLDocument(operations) {
        const html = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>æ“ä½œæµç¨‹æ–‡æ¡£</title>
            <style>
              body {
                font-family: 'Microsoft YaHei', SimHei, Arial, sans-serif;
                line-height: 1.6;
                color: #333;
                margin: 0;
                padding: 20px;
                max-width: 25cm;
                margin: 0 auto;
              }
              h1 {
                font-size: 24px;
                color: #333;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #4CAF50;
                padding-bottom: 10px;
              }
              h2 {
                font-size: 18px;
                color: #333;
                margin-top: 20px;
                margin-bottom: 10px;
              }
              .step { margin-bottom: 20px; page-break-inside: avoid; }
              .step-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; }
              .step-info { color: #666; font-size: 14px; margin-bottom: 10px; }
              .screenshot {
                max-width: 100%;
                width: 20cm;
                height: auto;
                display: block;
                margin: 0 auto;
                border: 1px solid #ddd;
              }
              a {
                transition: all 0.3s ease;
              }
              a:hover {
                background: #5a4fcf !important;
                transform: scale(1.05);
              }
              @page {
                size: A4 landscape;
                margin: 2cm;
              }
              @media print {
                body {
                  max-width: 25cm;
                  margin: 0 auto;
                }
                .screenshot {
                  max-width: 100% !important;
                  width: 20cm !important;
                  height: auto !important;
                  page-break-inside: avoid;
                }
              }
            </style>
          </head>
          <body>
            <h1>æ“ä½œæµç¨‹æ–‡æ¡£</h1>
            <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
            ${operations.map((op, index) => `
              <div class="step">
                <div class="step-title">æ­¥éª¤ ${index + 1}: ${op.text || 'æœªçŸ¥æ“ä½œ'}</div>
                <div class="step-info">URL: ${op.url || 'æœªçŸ¥'}</div>
                <div class="step-info">æ—¶é—´: ${new Date(op.timestamp).toLocaleString()}</div>
                ${op.screenshot ? `<img src="${op.screenshot}" alt="æ“ä½œæˆªå›¾" class="screenshot">` : ''}
              </div>
            `).join('')}
          </body>
          </html>
        `;
        return html;
      }
    }

    // åˆå§‹åŒ–æµ‹è¯•ç®¡ç†å™¨
    document.addEventListener('DOMContentLoaded', () => {
      new TestExportManager();
    });
  </script>
</body>
</html>