# 智流华写插件销售网站设计方案

## 🎯 项目概述

### 产品定位
- **产品名称**：智流华写 - Chrome浏览器操作录制插件
- **目标用户**：企业培训师、产品经理、技术文档编写者、客服人员
- **核心价值**：自动化操作流程记录，一键生成专业操作文档

### 商业模式
- **免费版**：限制20页截图，只能导出PDF文件
- **付费版**：49元/年，无限制使用，支持导出MD文件
- **续费策略**：到期前30天开始提醒，支持自动续费
- **支付方式**：微信扫码支付，支持自动扣费
- **授权验证**：在线验证系统，实时检查到期状态

---

## 🌐 网站架构设计

### 1. 首页 (Landing Page)
```
智流华写 - 让操作记录变得简单
[Hero Section]
- 主标题：智流华写 - 专业的操作流程记录工具
- 副标题：一键录制，自动截图，智能生成操作文档
- CTA按钮：[免费试用] [立即购买]
- 产品演示视频/GIF

[功能特色]
✅ 自动截图记录
✅ 智能点击跟踪  
✅ 一键导出文档
✅ 支持所有网站
✅ 操作简单易用
✅ 专业文档输出

[使用场景]
📋 企业培训文档制作
📋 产品操作说明编写
📋 客服流程标准化
📋 技术文档快速生成

[价格方案]
免费版 vs 专业版对比表
```

### 2. 产品功能页面
```
[核心功能展示]
- 功能1：智能截图 - 自动捕获关键操作步骤
- 功能2：点击跟踪 - 精准标记用户操作位置
- 功能3：文档生成 - 一键导出专业Markdown文档
- 功能4：多场景支持 - 适用于各类网站和系统

[技术优势]
- Chrome插件技术，兼容性强
- 本地处理，数据安全
- 轻量级设计，不影响浏览速度
- 智能识别，减少手动操作
```

### 3. 定价页面
```
[定价策略]
免费版：
- ✅ 基础录制功能
- ✅ 20页截图限制
- ✅ 仅支持PDF导出
- ❌ 无技术支持
- ❌ 不支持MD格式

专业版 - ¥49/年：
- ✅ 无限制录制
- ✅ 无限截图数量
- ✅ 支持PDF + MD导出
- ✅ 优先技术支持
- ✅ 定期功能更新
- ✅ 商业使用授权

[支付方式]
- 微信扫码支付
- 支付宝支付
- 银行卡支付
```

### 4. 用户中心
```
[登录方式]
- 微信扫码登录（唯一登录方式）

[用户面板]
- 个人信息
- 订阅状态
- 使用统计
- 授权管理
- 发票申请
```

---

## 🔐 授权系统设计

### 1. 用户认证流程
```
1. 用户访问网站
2. 微信扫码登录
3. 获取用户openid
4. 生成用户账户
5. 显示订阅状态
```

### 2. 购买流程
```
1. 选择专业版套餐
2. 微信扫码支付
3. 支付成功回调
4. 激活用户授权
5. 生成授权码
6. 插件验证授权
```

### 3. 插件授权验证
```javascript
// 插件端授权检查
async function checkLicense() {
  const userToken = await chrome.storage.local.get(['userToken']);
  
  if (!userToken) {
    // 未登录，使用免费版限制
    return { type: 'free', limit: 20 };
  }
  
  // 向服务器验证授权
  const response = await fetch('https://api.zhiliuhuaxie.com/auth/verify', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${userToken}` }
  });
  
  const result = await response.json();
  return result; // { type: 'premium', limit: -1 } 或 { type: 'free', limit: 20 }
}
```

---

## 🔗 网站与插件互动机制

### 1. 用户授权同步流程
```
网站登录 → 插件授权同步流程：

1. 用户在网站登录/购买
2. 网站生成用户Token和授权信息
3. 用户在插件中输入授权码或扫码绑定
4. 插件获取并存储用户授权信息
5. 插件实时验证用户权限状态
```

### 2. 插件授权绑定方式

#### 方式一：授权码绑定
```javascript
// 网站生成授权码
function generateAuthCode(userId) {
  const authCode = generateRandomCode(8); // 8位随机码
  const expireTime = Date.now() + 10 * 60 * 1000; // 10分钟有效
  
  // 存储到Redis
  redis.setex(`auth_code:${authCode}`, 600, JSON.stringify({
    userId,
    expireTime,
    used: false
  }));
  
  return authCode;
}

// 插件端输入授权码
async function bindWithAuthCode(authCode) {
  const response = await fetch('https://api.zhiliuhuaxie.com/auth/bind', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ authCode })
  });
  
  if (response.ok) {
    const { token, userInfo, subscription } = await response.json();
    
    // 存储到插件本地
    await chrome.storage.local.set({
      userToken: token,
      userInfo: userInfo,
      subscription: subscription,
      lastSync: Date.now()
    });
    
    return { success: true };
  }
}
```

#### 方式二：二维码扫码绑定
```javascript
// 网站生成绑定二维码
function generateBindingQR(userId) {
  const bindingId = generateUUID();
  const qrData = {
    type: 'plugin_binding',
    bindingId,
    userId,
    timestamp: Date.now()
  };
  
  // 存储绑定信息
  redis.setex(`binding:${bindingId}`, 300, JSON.stringify({
    userId,
    status: 'pending',
    createdAt: Date.now()
  }));
  
  return `https://zhiliuhuaxie.com/bind/${bindingId}`;
}

// 插件扫码绑定
async function bindWithQR(bindingId) {
  const response = await fetch(`https://api.zhiliuhuaxie.com/auth/bind/${bindingId}`, {
    method: 'POST'
  });
  
  if (response.ok) {
    const { token, userInfo, subscription } = await response.json();
    // 存储授权信息...
  }
}
```

### 3. 实时权限验证系统
```javascript
// 插件端权限检查（每次操作前调用）
class PermissionManager {
  constructor() {
    this.lastCheck = 0;
    this.checkInterval = 5 * 60 * 1000; // 5分钟检查一次
    this.userPermission = null;
  }

  async checkPermission(forceCheck = false) {
    const now = Date.now();
    
    // 如果距离上次检查不到5分钟且不是强制检查，使用缓存
    if (!forceCheck && (now - this.lastCheck) < this.checkInterval && this.userPermission) {
      return this.userPermission;
    }

    try {
      const { userToken } = await chrome.storage.local.get(['userToken']);
      
      if (!userToken) {
        this.userPermission = { type: 'free', limit: 20, used: 0 };
        return this.userPermission;
      }

      const response = await fetch('https://api.zhiliuhuaxie.com/auth/permission', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${userToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const permission = await response.json();
        this.userPermission = permission;
        this.lastCheck = now;
        
        // 更新本地存储
        await chrome.storage.local.set({
          lastPermissionCheck: now,
          userPermission: permission
        });
        
        return permission;
      } else if (response.status === 401) {
        // Token过期，清除本地数据
        await this.clearUserData();
        this.userPermission = { type: 'free', limit: 20, used: 0 };
        return this.userPermission;
      }
    } catch (error) {
      console.error('权限检查失败:', error);
      // 网络错误时使用本地缓存
      const { userPermission } = await chrome.storage.local.get(['userPermission']);
      return userPermission || { type: 'free', limit: 20, used: 0 };
    }
  }

  async clearUserData() {
    await chrome.storage.local.remove([
      'userToken', 'userInfo', 'subscription', 
      'userPermission', 'lastPermissionCheck'
    ]);
  }
}
```

### 4. 使用统计同步
```javascript
// 插件使用统计上报
class UsageReporter {
  constructor() {
    this.pendingReports = [];
    this.reportInterval = 30 * 1000; // 30秒上报一次
    this.startReporting();
  }

  // 记录截图操作
  async recordScreenshot(screenshotData) {
    const usage = {
      type: 'screenshot',
      timestamp: Date.now(),
      url: screenshotData.url,
      title: screenshotData.title
    };
    
    this.pendingReports.push(usage);
    
    // 立即检查是否需要限制
    const permission = await permissionManager.checkPermission();
    if (permission.type === 'free') {
      const currentUsage = await this.getCurrentUsage();
      if (currentUsage.screenshots >= permission.limit) {
        throw new Error('已达到免费版使用限制');
      }
    }
  }

  // 记录导出操作
  async recordExport(exportData) {
    const usage = {
      type: 'export',
      format: exportData.format,
      timestamp: Date.now(),
      pageCount: exportData.pageCount
    };
    
    this.pendingReports.push(usage);
  }

  // 定时上报使用统计
  async startReporting() {
    setInterval(async () => {
      if (this.pendingReports.length > 0) {
        await this.submitUsageReports();
      }
    }, this.reportInterval);
  }

  async submitUsageReports() {
    const { userToken } = await chrome.storage.local.get(['userToken']);
    
    if (!userToken || this.pendingReports.length === 0) return;

    try {
      const response = await fetch('https://api.zhiliuhuaxie.com/usage/report', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${userToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reports: this.pendingReports
        })
      });

      if (response.ok) {
        this.pendingReports = []; // 清空已上报的数据
      }
    } catch (error) {
      console.error('使用统计上报失败:', error);
      // 失败时保留数据，下次继续尝试
    }
  }

  async getCurrentUsage() {
    const { userToken } = await chrome.storage.local.get(['userToken']);
    
    if (!userToken) {
      // 未登录用户，从本地存储获取
      const { screenshotCount = 0 } = await chrome.storage.local.get(['screenshotCount']);
      return { screenshots: screenshotCount, exports: 0 };
    }

    try {
      const response = await fetch('https://api.zhiliuhuaxie.com/usage/current', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${userToken}`
        }
      });

      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error('获取使用统计失败:', error);
    }

    return { screenshots: 0, exports: 0 };
  }
}
```

### 5. 网站用户中心功能
```html
<!-- 用户中心 - 插件管理页面 -->
<div class="plugin-management">
  <h3>插件管理</h3>
  
  <!-- 插件绑定状态 -->
  <div class="binding-status">
    <div v-if="!pluginBound" class="not-bound">
      <p>插件未绑定</p>
      <div class="binding-methods">
        <div class="method-tabs">
          <button @click="activeTab = 'code'" :class="{active: activeTab === 'code'}">
            授权码绑定
          </button>
          <button @click="activeTab = 'qr'" :class="{active: activeTab === 'qr'}">
            扫码绑定
          </button>
        </div>
        
        <!-- 授权码绑定 -->
        <div v-if="activeTab === 'code'" class="auth-code-method">
          <div class="auth-code-display">
            <span class="code">{{ authCode }}</span>
            <button @click="refreshAuthCode">刷新</button>
          </div>
          <p class="instructions">
            1. 打开智流华写插件<br>
            2. 点击"绑定账户"<br>
            3. 输入上方授权码
          </p>
        </div>
        
        <!-- 二维码绑定 -->
        <div v-if="activeTab === 'qr'" class="qr-method">
          <div class="qr-code">
            <img :src="qrCodeUrl" alt="绑定二维码">
          </div>
          <p class="instructions">
            使用智流华写插件扫描二维码完成绑定
          </p>
        </div>
      </div>
    </div>
    
    <!-- 已绑定状态 -->
    <div v-else class="bound">
      <div class="bound-info">
        <span class="status-icon">✅</span>
        <span>插件已绑定</span>
        <span class="bind-time">绑定时间: {{ bindTime }}</span>
      </div>
      <button @click="unbindPlugin" class="unbind-btn">解除绑定</button>
    </div>
  </div>
  
  <!-- 使用统计 -->
  <div class="usage-stats">
    <h4>本月使用统计</h4>
    <div class="stats-grid">
      <div class="stat-item">
        <span class="label">截图次数</span>
        <span class="value">{{ usage.screenshots }}</span>
      </div>
      <div class="stat-item">
        <span class="label">导出次数</span>
        <span class="value">{{ usage.exports }}</span>
      </div>
      <div class="stat-item">
        <span class="label">使用天数</span>
        <span class="value">{{ usage.activeDays }}</span>
      </div>
    </div>
  </div>
  
  <!-- 订阅状态 -->
  <div class="subscription-status">
    <h4>订阅状态</h4>
    <div v-if="subscription.type === 'premium'" class="premium-status">
      <span class="status">专业版</span>
      <span class="expire-date">到期时间: {{ subscription.endDate }}</span>
      <button v-if="subscription.daysLeft <= 30" @click="renewSubscription" class="renew-btn">
        续费 ({{ subscription.daysLeft }}天后到期)
      </button>
    </div>
    <div v-else class="free-status">
      <span class="status">免费版</span>
      <span class="limit">剩余 {{ 20 - usage.screenshots }} 次截图</span>
      <button @click="upgradeSubscription" class="upgrade-btn">
        升级专业版
      </button>
    </div>
  </div>
</div>
```

### 6. API接口设计
```javascript
// 后端API接口
const apiRoutes = {
  // 权限验证
  'GET /auth/permission': async (req, res) => {
    const userId = req.user.id;
    const subscription = await getActiveSubscription(userId);
    const usage = await getCurrentMonthUsage(userId);
    
    if (subscription && subscription.status === 'active' && subscription.endDate > new Date()) {
      res.json({
        type: 'premium',
        limit: -1,
        used: usage.screenshots,
        subscription: subscription,
        features: ['unlimited_screenshots', 'md_export', 'priority_support']
      });
    } else {
      res.json({
        type: 'free',
        limit: 20,
        used: usage.screenshots,
        features: ['basic_screenshots', 'pdf_export']
      });
    }
  },

  // 使用统计上报
  'POST /usage/report': async (req, res) => {
    const userId = req.user.id;
    const { reports } = req.body;
    
    for (const report of reports) {
      await saveUsageRecord({
        userId,
        type: report.type,
        timestamp: new Date(report.timestamp),
        metadata: report
      });
    }
    
    res.json({ success: true });
  },

  // 插件绑定
  'POST /auth/bind': async (req, res) => {
    const { authCode } = req.body;
    const bindingInfo = await redis.get(`auth_code:${authCode}`);
    
    if (!bindingInfo) {
      return res.status(400).json({ error: '授权码无效或已过期' });
    }
    
    const { userId } = JSON.parse(bindingInfo);
    const user = await getUserById(userId);
    const subscription = await getActiveSubscription(userId);
    
    // 生成插件专用Token
    const pluginToken = jwt.sign(
      { userId, type: 'plugin' },
      process.env.JWT_SECRET,
      { expiresIn: '365d' }
    );
    
    // 标记授权码已使用
    await redis.del(`auth_code:${authCode}`);
    
    // 记录绑定信息
    await savePluginBinding({
      userId,
      token: pluginToken,
      bindTime: new Date(),
      userAgent: req.headers['user-agent']
    });
    
    res.json({
      token: pluginToken,
      userInfo: {
        id: user.id,
        nickname: user.nickname,
        avatar: user.avatar
      },
      subscription: subscription
    });
  }
};
```

---

## 💻 技术架构

### 前端技术栈
```
- 框架：Next.js 14 (React)
- 样式：Tailwind CSS
- UI组件：Shadcn/ui
- 状态管理：Zustand
- 支付集成：微信支付SDK
```

### 后端技术栈
```
- 框架：Node.js + Express
- 数据库：MongoDB
- 认证：JWT + 微信OAuth
- 支付：微信支付API
- 部署：Vercel/阿里云
```

### 数据库设计
```javascript
// 用户表
const UserSchema = {
  _id: ObjectId,
  openid: String,        // 微信openid
  nickname: String,      // 微信昵称
  avatar: String,        // 头像URL
  phone: String,         // 手机号
  email: String,         // 邮箱
  createdAt: Date,
  updatedAt: Date
}

// 订阅表
const SubscriptionSchema = {
  _id: ObjectId,
  userId: ObjectId,      // 用户ID
  type: String,          // 'free' | 'premium'
  startDate: Date,       // 开始时间
  endDate: Date,         // 结束时间
  status: String,        // 'active' | 'expired' | 'cancelled'
  paymentId: String,     // 支付订单号
  createdAt: Date
}

// 使用统计表
const UsageSchema = {
  _id: ObjectId,
  userId: ObjectId,
  date: Date,           // 使用日期
  screenshotCount: Number, // 当日截图数量
  documentCount: Number,   // 当日文档生成数量
}
```

---

## 🎨 UI/UX 设计

### 1. 设计风格
```
- 色彩方案：蓝绿色主色调 (#00CED1, #20B2AA)
- 设计风格：现代简约，专业商务
- 字体：思源黑体/Inter
- 布局：响应式设计，移动端友好
```

### 2. 关键页面设计

#### 首页设计
```html
<!-- Hero Section -->
<section class="bg-gradient-to-r from-cyan-500 to-teal-500">
  <div class="container mx-auto px-4 py-20">
    <div class="text-center text-white">
      <h1 class="text-5xl font-bold mb-6">智流华写</h1>
      <p class="text-xl mb-8">让操作记录变得简单，让文档编写更高效</p>
      <div class="space-x-4">
        <button id="wechat-login-btn" class="bg-white text-teal-600 px-8 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-gray-100 transition-colors">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="#07C160">
            <path d="M18.5 9.5c0-4.1-4-7.5-8.5-7.5S1.5 5.4 1.5 9.5c0 2.4 1.3 4.5 3.3 5.8-.2.6-.5 1.8-.5 1.8s1.3-.4 2.3-.8c.7.2 1.4.3 2.2.3 4.5 0 8.2-3.4 8.2-7.6zm-11.8.9c-.6 0-1.1-.5-1.1-1.1s.5-1.1 1.1-1.1 1.1.5 1.1 1.1-.5 1.1-1.1 1.1zm5.6 0c-.6 0-1.1-.5-1.1-1.1s.5-1.1 1.1-1.1 1.1.5 1.1 1.1-.5 1.1-1.1 1.1z"/>
            <path d="M22.5 14.5c0-3.2-3.2-5.8-6.8-5.8s-6.8 2.6-6.8 5.8c0 1.9 1 3.6 2.6 4.6-.2.5-.4 1.4-.4 1.4s1-.3 1.8-.6c.5.1 1.1.2 1.7.2 3.6 0 6.8-2.6 6.8-5.6z"/>
          </svg>
          微信登录
        </button>
        <button class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-teal-600 transition-colors">
          了解更多
        </button>
      </div>
    </div>
  </div>
</section>

<!-- 功能特色 -->
<section class="py-20">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-bold text-center mb-12">核心功能</h2>
    <div class="grid md:grid-cols-3 gap-8">
      <!-- 功能卡片 -->
    </div>
  </div>
</section>
```

#### 定价页面设计
```html
<section class="py-20 bg-gray-50">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-bold text-center mb-12">选择适合您的方案</h2>
    <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
      
      <!-- 免费版 -->
      <div class="bg-white rounded-lg shadow-lg p-8">
        <h3 class="text-2xl font-bold mb-4">免费版</h3>
        <div class="text-3xl font-bold mb-6">¥0 <span class="text-lg text-gray-500">/永久</span></div>
        <ul class="space-y-3 mb-8">
          <li class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-3">✓</svg>
            基础录制功能
          </li>
          <li class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-3">✓</svg>
            20页截图限制
          </li>
        </ul>
        <button class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg">
          当前方案
        </button>
      </div>
      
      <!-- 专业版 -->
      <div class="bg-white rounded-lg shadow-lg p-8 border-2 border-teal-500 relative">
        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
          <span class="bg-teal-500 text-white px-4 py-1 rounded-full text-sm">推荐</span>
        </div>
        <h3 class="text-2xl font-bold mb-4">专业版</h3>
        <div class="text-3xl font-bold mb-6">¥49 <span class="text-lg text-gray-500">/年</span></div>
        <ul class="space-y-3 mb-8">
          <li class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-3">✓</svg>
            无限制录制
          </li>
          <li class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-3">✓</svg>
            无限截图数量
          </li>
          <li class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-3">✓</svg>
            优先技术支持
          </li>
        </ul>
        <button class="w-full bg-teal-500 text-white py-3 rounded-lg hover:bg-teal-600">
          立即购买
        </button>
      </div>
    </div>
  </div>
</section>
```

---

## 📱 微信登录集成

### 1. 简化的微信登录实现
```javascript
// 微信登录配置
const wechatConfig = {
  appId: 'your_wechat_appid',
  appSecret: 'your_wechat_secret',
  redirectUri: 'https://zhiliuhuaxie.com/auth/callback',
  scope: 'snsapi_login'
}

// 前端：一键微信登录
function initWechatLogin() {
  const loginBtn = document.getElementById('wechat-login-btn');
  
  loginBtn.onclick = () => {
    // 显示登录二维码弹窗
    showWechatQRModal();
  };
}

function showWechatQRModal() {
  const state = generateRandomString(32);
  const qrUrl = `https://open.weixin.qq.com/connect/qrconnect?` +
    `appid=${wechatConfig.appId}&` +
    `redirect_uri=${encodeURIComponent(wechatConfig.redirectUri)}&` +
    `response_type=code&` +
    `scope=${wechatConfig.scope}&` +
    `state=${state}`;

  // 创建登录弹窗
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div class="login-modal-overlay">
      <div class="login-modal">
        <div class="modal-header">
          <h3>微信登录</h3>
          <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="qr-container">
            <iframe src="${qrUrl}" width="300" height="400" frameborder="0"></iframe>
          </div>
          <p class="login-tip">请使用微信扫描二维码登录</p>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // 绑定关闭事件
  modal.querySelector('.close-btn').onclick = () => {
    document.body.removeChild(modal);
  };
  
  // 监听登录成功
  window.addEventListener('message', (event) => {
    if (event.data.type === 'wechat_login_success') {
      document.body.removeChild(modal);
      window.location.reload(); // 刷新页面显示登录状态
    }
  });
}

// 后端：处理微信登录回调
app.get('/auth/callback', async (req, res) => {
  const { code, state } = req.query;
  
  try {
    // 1. 通过code获取access_token
    const tokenResponse = await axios.get('https://api.weixin.qq.com/sns/oauth2/access_token', {
      params: {
        appid: wechatConfig.appId,
        secret: wechatConfig.appSecret,
        code: code,
        grant_type: 'authorization_code'
      }
    });
    
    const { access_token, openid } = tokenResponse.data;
    
    // 2. 获取用户信息
    const userResponse = await axios.get('https://api.weixin.qq.com/sns/userinfo', {
      params: {
        access_token: access_token,
        openid: openid
      }
    });
    
    const wechatUser = userResponse.data;
    
    // 3. 查找或创建用户
    let user = await User.findOne({ openid: openid });
    
    if (!user) {
      // 新用户，自动注册
      user = await User.create({
        openid: openid,
        nickname: wechatUser.nickname,
        avatar: wechatUser.headimgurl,
        createdAt: new Date()
      });
      
      // 创建免费订阅
      await Subscription.create({
        userId: user._id,
        type: 'free',
        status: 'active',
        startDate: new Date(),
        endDate: new Date('2099-12-31') // 免费版永不过期
      });
    } else {
      // 老用户，更新信息
      await User.updateOne(
        { _id: user._id },
        {
          nickname: wechatUser.nickname,
          avatar: wechatUser.headimgurl,
          lastLoginAt: new Date()
        }
      );
    }
    
    // 4. 生成JWT Token
    const token = jwt.sign(
      { userId: user._id, openid: user.openid },
      process.env.JWT_SECRET,
      { expiresIn: '30d' }
    );
    
    // 5. 设置Cookie并跳转
    res.cookie('auth_token', token, {
      httpOnly: true,
      secure: true,
      maxAge: 30 * 24 * 60 * 60 * 1000 // 30天
    });
    
    // 跳转到用户中心
    res.redirect('/dashboard');
    
  } catch (error) {
    console.error('微信登录失败:', error);
    res.redirect('/?error=login_failed');
  }
});
```

### 2. 支付集成
```javascript
// 微信支付配置
const wxPayConfig = {
  mchId: 'your_mch_id',
  key: 'your_api_key',
  notifyUrl: 'https://zhiliuhuaxie.com/api/payment/notify'
}

// 创建支付订单
async function createPaymentOrder(userId, amount) {
  const order = {
    out_trade_no: generateOrderNo(),
    body: '智流华写专业版-年费订阅',
    total_fee: amount * 100, // 分为单位
    spbill_create_ip: getClientIP(),
    notify_url: wxPayConfig.notifyUrl,
    trade_type: 'NATIVE'
  };
  
  // 调用微信支付API
  const result = await wxpay.unifiedOrder(order);
  return result.code_url; // 返回支付二维码
}
```

---

## 🔧 插件授权改造

### 1. 添加授权检查
```javascript
// content.js 中添加授权检查
class ContentRecorder {
  constructor() {
    this.screenshotCount = 0;
    this.userLicense = null;
    this.init();
  }

  async init() {
    // 检查用户授权
    this.userLicense = await this.checkLicense();
    console.log('用户授权状态:', this.userLicense);
  }

  async checkLicense() {
    try {
      const result = await chrome.storage.local.get(['userToken', 'screenshotCount']);
      
      if (!result.userToken) {
        return { type: 'free', limit: 20, used: result.screenshotCount || 0 };
      }

      // 向服务器验证授权
      const response = await fetch('https://api.zhiliuhuaxie.com/auth/verify', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${result.userToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        return data;
      } else {
        return { type: 'free', limit: 20, used: result.screenshotCount || 0 };
      }
    } catch (error) {
      console.error('授权验证失败:', error);
      return { type: 'free', limit: 20, used: 0 };
    }
  }

  async captureScreenshot() {
    // 检查是否超出限制
    if (this.userLicense.type === 'free' && this.screenshotCount >= this.userLicense.limit) {
      this.showUpgradeDialog();
      return;
    }

    // 执行截图
    this.screenshotCount++;
    await chrome.storage.local.set({ screenshotCount: this.screenshotCount });
    
    // 原有截图逻辑...
  }

  async exportDocument(format = 'auto') {
    // 根据用户授权决定导出格式
    const allowedFormat = this.userLicense.type === 'premium' ? format : 'pdf';
    
    if (format === 'md' && this.userLicense.type === 'free') {
      this.showFormatUpgradeDialog();
      return;
    }
    
    // 执行相应格式的导出
    if (allowedFormat === 'pdf') {
      await this.exportToPDF();
    } else {
      await this.exportToMarkdown();
    }
  }

  showUpgradeDialog() {
    const dialog = document.createElement('div');
    dialog.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                  background: rgba(0,0,0,0.5); z-index: 999999; display: flex; 
                  align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; 
                    text-align: center; max-width: 400px;">
          <h3 style="margin-bottom: 15px; color: #333;">免费版限制</h3>
          <p style="margin-bottom: 20px; color: #666;">
            您已达到免费版20页截图限制<br>
            升级到专业版享受无限制使用
          </p>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="upgradeBtn" style="background: #20B2AA; color: white; 
                    border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              立即升级 ¥49/年
            </button>
            <button id="cancelBtn" style="background: #ccc; color: #333; 
                    border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              取消
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    document.getElementById('upgradeBtn').onclick = () => {
      window.open('https://zhiliuhuaxie.com/pricing', '_blank');
      dialog.remove();
    };
    
    document.getElementById('cancelBtn').onclick = () => {
      dialog.remove();
    };
  }

  showFormatUpgradeDialog() {
    const dialog = document.createElement('div');
    dialog.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                  background: rgba(0,0,0,0.5); z-index: 999999; display: flex; 
                  align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; 
                    text-align: center; max-width: 400px;">
          <h3 style="margin-bottom: 15px; color: #333;">格式限制</h3>
          <p style="margin-bottom: 20px; color: #666;">
            免费版仅支持PDF格式导出<br>
            升级到专业版支持MD格式导出
          </p>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="exportPdfBtn" style="background: #666; color: white; 
                    border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              导出PDF
            </button>
            <button id="upgradeBtn" style="background: #20B2AA; color: white; 
                    border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              升级专业版
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    document.getElementById('exportPdfBtn').onclick = () => {
      this.exportToPDF();
      dialog.remove();
    };
    
    document.getElementById('upgradeBtn').onclick = () => {
      window.open('https://zhiliuhuaxie.com/pricing', '_blank');
      dialog.remove();
    };
  }
}
```

### 2. 添加登录功能
```javascript
// popup.js 中添加登录功能
class PopupController {
  constructor() {
    this.userInfo = null;
    this.init();
  }

  async init() {
    await this.loadUserInfo();
    this.bindEvents();
    this.updateUI();
  }

  async loadUserInfo() {
    const result = await chrome.storage.local.get(['userToken', 'userInfo']);
    if (result.userToken && result.userInfo) {
      this.userInfo = result.userInfo;
    }
  }

  showLoginDialog() {
    // 打开登录页面
    chrome.tabs.create({ url: 'https://zhiliuhuaxie.com/login' });
  }

  updateUI() {
    const userSection = document.getElementById('userSection');
    if (this.userInfo) {
      userSection.innerHTML = `
        <div class="user-info">
          <img src="${this.userInfo.avatar}" class="avatar">
          <span>${this.userInfo.nickname}</span>
          <span class="license-type">${this.userInfo.licenseType === 'premium' ? '专业版' : '免费版'}</span>
        </div>
      `;
    } else {
      userSection.innerHTML = `
        <button id="loginBtn" class="btn btn-info">登录账户</button>
      `;
      document.getElementById('loginBtn').onclick = () => this.showLoginDialog();
    }
  }
}
```

---

## 🔄 续费机制设计

### 1. 续费提醒策略
```
到期前提醒时间线：
- 30天前：首次续费提醒（邮件+插件内通知）
- 15天前：第二次提醒（插件弹窗）
- 7天前：紧急提醒（每日提醒）
- 3天前：最后提醒（红色警告）
- 到期当天：服务降级为免费版
```

### 2. 自动续费机制
```javascript
// 自动续费配置
const autoRenewalConfig = {
  enabled: true,           // 是否开启自动续费
  advanceDays: 7,         // 提前续费天数
  maxRetries: 3,          // 支付失败重试次数
  retryInterval: 24       // 重试间隔（小时）
}

// 自动续费检查（每日定时任务）
async function checkAutoRenewal() {
  const subscriptions = await getExpiringSubscriptions(7); // 7天内到期
  
  for (const sub of subscriptions) {
    if (sub.autoRenewal && !sub.renewalProcessed) {
      try {
        await processAutoRenewal(sub);
        await sendRenewalSuccessNotification(sub);
      } catch (error) {
        await handleRenewalFailure(sub, error);
      }
    }
  }
}
```

### 3. 续费优惠策略
```
续费激励方案：
- 提前续费：提前30天续费享受9折优惠（44元）
- 连续续费：连续2年用户享受8.5折优惠（42元）
- 推荐奖励：推荐新用户购买，双方各获得1个月免费延期
- 学生优惠：学生认证用户享受7折优惠（34元）
```

### 4. 插件端续费提醒
```javascript
// popup.js 中添加续费状态显示
class PopupController {
  async updateSubscriptionStatus() {
    const subscription = await this.getSubscriptionInfo();
    const daysLeft = this.calculateDaysLeft(subscription.endDate);
    
    const statusElement = document.getElementById('subscriptionStatus');
    
    if (daysLeft <= 0) {
      // 已过期
      statusElement.innerHTML = `
        <div class="status-expired">
          <span>⚠️ 订阅已过期</span>
          <button class="renew-btn">立即续费</button>
        </div>
      `;
    } else if (daysLeft <= 7) {
      // 即将过期
      statusElement.innerHTML = `
        <div class="status-expiring">
          <span>⏰ ${daysLeft}天后到期</span>
          <button class="renew-btn">续费享9折</button>
        </div>
      `;
    } else if (daysLeft <= 30) {
      // 提前提醒
      statusElement.innerHTML = `
        <div class="status-reminder">
          <span>📅 ${daysLeft}天后到期</span>
          <button class="renew-btn">提前续费</button>
        </div>
      `;
    } else {
      // 正常状态
      statusElement.innerHTML = `
        <div class="status-active">
          <span>✅ 专业版 (${daysLeft}天)</span>
        </div>
      `;
    }
  }
}
```

### 5. 续费数据库设计
```javascript
// 续费记录表
const RenewalSchema = {
  _id: ObjectId,
  userId: ObjectId,
  subscriptionId: ObjectId,
  renewalDate: Date,        // 续费日期
  newEndDate: Date,         // 新的到期日期
  amount: Number,           // 续费金额
  discount: Number,         // 折扣金额
  paymentMethod: String,    // 支付方式
  autoRenewal: Boolean,     // 是否自动续费
  status: String,           // 'success' | 'failed' | 'pending'
  createdAt: Date
}

// 续费提醒记录表
const ReminderSchema = {
  _id: ObjectId,
  userId: ObjectId,
  reminderType: String,     // '30days' | '15days' | '7days' | '3days'
  sentAt: Date,
  channel: String,          // 'email' | 'plugin' | 'sms'
  status: String            // 'sent' | 'failed'
}
```

### 6. 续费失败处理
```javascript
async function handleRenewalFailure(subscription, error) {
  // 记录失败原因
  await logRenewalFailure(subscription.id, error);
  
  // 发送失败通知
  await sendRenewalFailureNotification(subscription.userId, {
    reason: error.message,
    nextRetry: new Date(Date.now() + 24 * 60 * 60 * 1000),
    manualRenewalUrl: `https://zhiliuhuaxie.com/renew/${subscription.id}`
  });
  
  // 安排重试
  if (subscription.retryCount < 3) {
    await scheduleRenewalRetry(subscription.id, subscription.retryCount + 1);
  } else {
    // 重试次数用完，发送最终通知
    await sendFinalRenewalNotice(subscription.userId);
  }
}
```

### 7. 用户续费体验优化
```
续费流程优化：
1. 一键续费：用户中心显著位置放置续费按钮
2. 价格透明：清楚显示原价、折扣价、优惠信息
3. 支付便捷：支持微信、支付宝、银行卡多种方式
4. 即时生效：支付成功后立即延长服务期限
5. 发票服务：支持开具电子发票
6. 客服支持：续费问题专门客服通道
```

### 8. 续费营销策略
```
营销时机：
- 使用高峰期：用户频繁使用时推送续费优惠
- 功能升级：新功能发布时提醒续费享受新特性
- 节日促销：春节、双11等节日推出续费优惠
- 生日优惠：用户注册周年日推送专属优惠

营销渠道：
- 插件内通知：最直接的触达方式
- 邮件营销：详细的续费说明和优惠信息
- 微信公众号：推送续费提醒和优惠活动
- 短信通知：重要的到期提醒
```

### 9. 续费数据分析
```
关键指标监控：
- 续费率：月度/年度续费率统计
- 流失分析：用户流失原因和时间点分析
- 价格敏感度：不同价格策略的续费效果
- 提醒效果：各种提醒方式的转化率
- 优惠效果：不同优惠策略的续费促进效果
```

---

## 📊 运营策略

### 1. 推广策略
```
- SEO优化：关键词"操作录制"、"文档生成"、"Chrome插件"
- 内容营销：技术博客、使用教程、案例分享
- 社交媒体：微信公众号、知乎、B站教程视频
- 合作推广：与企业培训机构、SaaS平台合作
```

### 2. 用户增长
```
- 免费试用：20页限制吸引用户体验
- 推荐奖励：推荐好友获得延长试用
- 企业版本：针对团队用户的批量授权
- 功能迭代：根据用户反馈持续优化
```

### 3. 数据分析
```
- 用户行为：使用频率、功能偏好、转化路径
- 收入分析：月度收入、用户生命周期价值
- 产品优化：功能使用率、用户反馈分析
```

---

## 🚀 实施计划

### 第一阶段（1-2周）
- [ ] 网站前端开发
- [ ] 用户系统搭建
- [ ] 微信登录集成
- [ ] 支付系统对接

### 第二阶段（2-3周）
- [ ] 插件授权改造
- [ ] API接口开发
- [ ] 数据库设计实现
- [ ] 测试环境部署

### 第三阶段（1周）
- [ ] 全面测试
- [ ] 性能优化
- [ ] 安全检查
- [ ] 正式上线

### 第四阶段（持续）
- [ ] 用户反馈收集
- [ ] 功能迭代优化
- [ ] 市场推广
- [ ] 数据分析优化

---

## 💰 成本预算

### 开发成本
- 前端开发：15,000元
- 后端开发：20,000元
- UI设计：8,000元
- 测试部署：5,000元
- **总计：48,000元**

### 运营成本（年）
- 服务器费用：3,600元/年
- 域名SSL：500元/年
- 微信支付费率：0.6%
- 推广费用：10,000元/年
- **总计：约14,100元/年**

### 收益预测（考虑续费）
**第一年**：
- 新增付费用户：1000个
- 年收入：49,000元
- 净利润：约35,000元

**第二年**（假设70%续费率）：
- 续费用户：700个 × 49元 = 34,300元
- 新增用户：500个 × 49元 = 24,500元
- 总收入：58,800元
- 净利润：约44,700元

**第三年**（假设75%续费率）：
- 续费用户：900个 × 49元 = 44,100元
- 新增用户：300个 × 49元 = 14,700元
- 总收入：58,800元
- 净利润：约44,700元

**续费率提升策略**：
- 目标续费率：第一年70% → 第二年75% → 第三年80%
- 关键措施：优质服务、功能迭代、用户粘性提升
- 长期价值：单个用户LTV约147元（3年平均）

---

## 📞 联系方式

如需详细的技术实现方案或有任何问题，请联系：
- 邮箱：contact@zhiliuhuaxie.com
- 微信：zhiliuhuaxie
- 官网：https://zhiliuhuaxie.com

---

*本设计方案为智流华写插件商业化的完整解决方案，涵盖了从产品定位到技术实现的所有关键环节。*